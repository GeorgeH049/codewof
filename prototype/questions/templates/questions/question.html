{% extends "questions/base.html" %}

{% block content %}
<b>{{question.title}}</b>
<p>
    {{question.question_text}}
</p>
<textarea id="user_input">print(2)</textarea>
<p>
    <input id="submit" type="button" value="Submit" />
</p>
<div id="loading">
    Loading...
</div>
<div id="result-table">
    <div class="header">
        {% for title in question.test_cases.all %}
            <div class="cell">
                {{title}}
            </div>
        {% endfor %}
    </div>
    <div class="row">
        <div class="cell">

        </div>
    </div>
</div>
<div id="error">

</div>
<div id="all-correct">
    Well done!
</div>
{% endblock %}

{% block javascript %}
<script>

    var hide_results = function() {
        $('#result-table').hide();
        $('#error').hide();
        $('#all-correct').hide();
    }

    var poll_sphere_engine = function(id) {
        $.ajax({
            url: '/ajax/get_output/',
            method: 'GET',
            data: {
                id: id,
                question: '{{ question.id }}'
            },
            dataType: 'json',
            success: function(result) {
                
                console.log(result);
                if (result.completed) {
                    $('#loading').hide();
                    $('#result-table').show();
                    // todo display output in structure like coderunner
                    
                    if (result.output.length > 0) {
                        var output = JSON.parse(result.output.slice(0, -1));
                        var correctness_array = output["correct"];
                        console.log(correctness_array);
                        var all_correct = true;
                        for (var i = 0; i < correctness_array.length; i++) {
                            if (correctness_array[i] == false) {
                                all_correct = false;
                            }
                        }
                        if (all_correct) {
                            $('#all-correct').show();
                        }
                    } else {
                        if (result.stderr.length > 0) {
                            $('#error').text(result.stderr);
                        } else {
                            $('#error').text(result.cmpinfo);
                        }
                    }
                } else {
                    poll_sphere_engine(id);
                }
            }
        });
    }

    $("#submit").click(function () {
        var user_input = $("#user_input").val();

        $.ajax({
            url: '/ajax/send_code/',
            method: 'POST',
            data: {
                user_input: user_input,
                question: '{{ question.id }}',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            dataType: 'json',
            success: function (result) {
                var submission_id = result.id;
                console.log(submission_id);
                $('#loading').show();
                hide_results();
                poll_sphere_engine(submission_id);
            }
        });
    });

    $('#loading').hide();
    hide_results();
</script>
{% endblock %}