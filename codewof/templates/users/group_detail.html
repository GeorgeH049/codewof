{% extends "base.html" %}
{% load static %}

{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}{% trans "New Group" %}{% endblock %}

{% block content %}
<div class="container">
  {% if is_admin %}
  <div id="alert-div" class="sticky-top" style="top: 40px">
    <div id="update-success-alert" class="alert alert-success alert-dismissible collapse" role="alert">
      Memberships successfully updated.
    </div>

    <div id="update-danger-alert" class="alert alert-danger alert-dismissible collapse" role="alert"></div>
  </div>

  <div id="demote-self-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Warning!</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>You are about to demote yourself. You will lose access to Admin privileges for this group.</p>

          <p>Are you sure?</p>
        </div>
        <div class="modal-footer">
          <button id="demote-self-modal-button" type="button" class="btn btn-primary">Continue</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row">
    <div class="col-12 col-md-8 mb-3">
      <div class="row">
        <div class="col">
          <h1>{{ group.name }}</h1>
          <p>{{ group.description }}</p>
        </div>

        <div class="col-sm-auto">
          {% if is_admin %}
            <a class="btn btn-primary btn-sm d-block mb-1 mt-2" href="{% url 'users:groups-edit' group.pk %}">
              Edit Group</a>
            <a class="btn btn-danger btn-sm d-block mb-1" href="{% url 'users:groups-delete' group.pk %}">Delete Group</a>
          {% endif %}
          <a id="leave-button" class="btn btn-warning btn-sm d-block mb-1 {% if not is_admin %} mt-2 {% endif %}"
             {% if only_admin %} style="visibility: hidden" {% endif %}
             href="{% url 'users:groups-memberships-delete' user_membership.pk %}">Leave Group</a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12 col-md-8 mb-3">
      <h2>Members</h2>

      <table id="members-table" class="table">
        <thead>
        <tr>
          <th scope="col">Email</th>
          <th scope="col">Name</th>
          <th scope="col">Role</th>
          {% if is_admin %}
          <th scope="col">Remove?</th>
          {% endif %}
        </tr>
        </thead>

        <tbody id="members-table-tbody">
        {% for membership in memberships %}
        <tr id="membership-{{ membership.pk }}">
          <td>{{ membership.user.email }}</td>
          <td>{{ membership.user.first_name }} {{ membership.user.last_name }}</td>
          {% if is_admin %}
          <td>
            <select id="membership-{{ membership.pk }}-select" class="form-select" aria-label="Default select example" autocomplete=off>
              {% for role in roles %}
              {% if role == membership.role %}
              <option selected>{{ role }}</option>
              {% else %}
              <option>{{ role }}</option>
              {% endif %}}
              {% endfor %}
            </select>
          </td>
          <td class="text-center">
            <input id="membership-{{ membership.pk }}-checkbox" class="form-check-input" type="checkbox" value="" autocomplete=off {% if user.pk == membership.user.pk %}disabled{% endif %}>
          </td>
          {% else %}
          <td>{{ membership.role }}</td>
          {% endif %}
        </tr>
        {% endfor %}
        </tbody>

      </table>
    </div>
  </div>

  <div class="row">
    <div class="col-12 col-md-8 mb-3">
      <a id="email-button" class="btn btn-primary mb-1 btn-sm float-right" href="">Email All</a>
      {% if is_admin %}
        <button id="save-button" class="btn btn-success btn-sm mb-1">Save</button>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
{% csrf_token %}
<script>
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
const membershipsUpdateURL = "{% url 'users:groups-memberships-update' group.pk %}"
const currentUserMembershipID = "{{ user_membership.pk }}"
</script>

<script src="{% static 'js/groups/group_detail_general.js' %}"></script>
{% if is_admin %}
<script src="{% static 'js/groups/group_detail_admin.js' %}"></script>
{% endif %}
{% endblock scripts %}
